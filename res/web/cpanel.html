<!DOCTYPE html>
<!--
 cpanel.html 
 
 Copyright (C) 2018  Bal Chettri
 Licensed under GNU GPL(https://www.gnu.org/licenses/gpl.html)
-->
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=devide-width, initial-scale=1.0" />
    <title>MobiCast Control Panel</title>
  </head>
  <body>
    Pair phone:<br />
    Id:&nbsp;<input type="text" id="phone_id" style="width:100px" value="0123456789" />
    &nbsp;&nbsp;
    Name:&nbsp;<input type="text" id="phone_name" style="width:100px" value="CPanel" />
    <input type="button" style="width:80px" value="Pair"  onclick="pairPhone();" />
    <br /><br />
    
    Activate phone:<br />
    Passcode:&nbsp;<input type="text" id="phone_passcode" style="width:100px" value="" />
    <input type="button" style="width:80px" value="Activate"  onclick="activatePhone();" />
    <br /><br />
    
    Get Channels:<br />
    <input type="button" style="width:80px" value="Channels"  onclick="getChannels();" />    
    <br /><br />
    
    Get Channel:<br />
    <input type="button" style="width:80px" value="Channel" onclick="getChannel();" />
    <input type="text" style="width:50px" id="get_channel_id"" />
    <br /><br />
    
    List Channel:<br />
    <input type="button" style="width:80px" value="List" onclick="listChannel();" />
    <input type="text" style="width:50px" id="list_channel_id"" />
    <br /><br />
    
    Get Plugins:<br />
    <input type="button" style="width:80px" value="List" onclick="getPlugins();" />
    <br /><br />
    
    List Media Handlers:<br />
    <input type="button" style="width:80px" value="List" onclick="listMediaHandlers();" />
    <br /><br />
    
    Media:<br />
    <input type="text" id="media" style="width:480px" value="https://www.youtube.com/watch?v=YgwX75JQUjc" />
    <br /><br />    
    
    Controls:<br />
    <input type="button" style="width:130px" value="Play via Youtube"  onclick="playYT();" />
    &nbsp;&nbsp;&nbsp;
    
    <input type="button" style="width:130px" value="Play via VLC"  onclick="playVLC();" />
    <br /><br />
    
    <input type="button" style="width:80px" value="Pause"  onclick="pause();" />
    <input type="button" style="width:80px" value="Resume" onclick="resume();" />
    <input type="button" style="width:80px" value="Rewind" onclick="rewind();" />
    <br /><br />
    
    <input type="button" style="width:60px" value="Vol +" onclick="volStep(true);" />
    <input type="button" style="width:60px" value="Vol -" onclick="volStep(false);" />
    <input type="button" style="width:80px" value="Mute" onclick="mute();" />
    <input type="button" style="width:80px" value="Unmute" onclick="unmute();" />
    <br /><br />
    
    Log:<br />
    <input type="button" style="width:80px" value="Clear" onclick="clearLog();" />
    <br />
    <textarea id="output" style="width:480px; height:200px"></textarea>
  </body>
</html>
<script>
var SERVER = document.location.origin;

function logmsg(s) {
  var output = document.getElementById('output');
  s = output.value + s + '\n';
  output.value = s;
}

function clearLog() {
  document.getElementById('output').value = '';
}

function httpReq(url, options, callback) {
  var method = 'method' in options ? options['method'] : 'GET';
  var async = 'async' in options ? options['async'] : true;
  var headers = 'headers' in options ? options['headers'] : null;
  var body = 'body' in options ? options['body'] : null;
  var xhttp = new XMLHttpRequest();
  if(xhttp == null) {
    logmsg('Failed to create XMLHttpRequest request.');
    return false;
  }
  xhttp.onreadystatechange = function() {
    if(this.readyState == 4) {      
      callback(this);
    }
  };
  xhttp.open(method, url, async);
  if(headers != null) {
    for(name in headers) {
      xhttp.setRequestHeader(name, headers[name]);
    }
  }
  
  var slog = url;
  if(method == 'POST') {
    slog+= '\n';
    slog+= body || '(null)';    
  }
  slog+= '\n';
  logmsg(slog);
  
  xhttp.send(body);
  return true;
}

function respHandler(xhttp) {
  var slog;
  if(xhttp.status == 200) {
    slog = JSON.stringify(JSON.parse(xhttp.responseText), null, '  ');
  } else {
    slog = 'Request failed with status code ' + xhttp.status;
  }
  slog+= '\n';
  slog+= '---------------------------------------------------------------\n';
  logmsg(slog);
}

function httpGet(url, callback) {
  callback = callback || respHandler;
  return httpReq(url, { }, callback);
}

function httpPost(url, body, callback) {
  callback = callback || respHandler;
  return httpReq(url, {"method": "POST", "body": body}, callback);
}

function API(surl) {
  return SERVER + surl;
}

////////////////////////////////////////////////////////////////////////////////

function pairPhone() {
  var id = document.getElementById('phone_id').value;
  var name = document.getElementById('phone_name').value;
  httpGet(API('/services/app.jss?cmd=pair_phone&id=' + id + '&name=' + name));
}

function activatePhone() {
  var id = document.getElementById('phone_id').value;
  var code = document.getElementById('phone_passcode').value;
  httpGet(API('/services/app.jss?cmd=activate_phone&id=' + id + '&code=' + code));
}

function getChannels() {
  httpGet(API('/services/media-api.jss?cmd=get_channels'));
}

function getChannel() { 
  httpGet(API('/services/media-api.jss?cmd=get_channel&channel_id=' + document.getElementById('get_channel_id').value));
}

function listChannel() {
  httpGet(API('/services/media-api.jss?cmd=list_channel&channel_id=' + document.getElementById('list_channel_id').value));
}

function getPlugins() {
  httpGet(API('/services/media-api.jss?cmd=get_plugins'));
}

function listMediaHandlers() {
  httpGet(API('/services/media-api.jss?cmd=list_media_handlers'));
}

function play(format, player) {
  var media = document.getElementById('media').value;
  var body = JSON.stringify({
    "mediaUrl": media,
    "format": format,
    "player": player,
    "registerPlayer": true
  });
  httpPost(API('/services/media-control.jss?cmd=play_media'), body);
}

function playYT() {
  play('.youtube', 'mc.plugin.yt');
}

function playVLC() {
  play('.youtube', 'mc.plugin.vlc');
}

function pause() {
  httpGet(API('/services/media-control.jss?cmd=pause_media'));
}

function resume() {
  httpGet(API('/services/media-control.jss?cmd=resume_media'));
}

function rewind() {
  httpGet(API('/services/media-control.jss?cmd=rewind_media'));
}

function volStep(stepUp) {
  if(stepUp) {
    httpGet(API('/services/media-control.jss?cmd=vol_up'));
  } else {
    httpGet(API('/services/media-control.jss?cmd=vol_down'));
  }
}

function mute() {
  httpGet(API('/services/media-control.jss?cmd=vol_mute'));
}

function unmute() {
  httpGet(API('/services/media-control.jss?cmd=vol_unmute'));
}

</script>
